name: Deploy to SiteGround

on:
  push:
    branches:
      # - main
      - copilot/add-ztest-page
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment triggered'

jobs:
  deploy:
    name: Deploy to SiteGround Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SG_SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SG_SSH_PASSPHRASE }}
          SG_SERVER: ${{ secrets.SG_SERVER }}
        run: |
          set +e  # Don't exit on error, we'll handle errors explicitly
          
          echo "Starting SSH key setup..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Validate SSH key is provided
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "Error: SG_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "✓ SSH_PRIVATE_KEY is set"
          
          # Validate server is provided
          if [ -z "$SG_SERVER" ]; then
            echo "Error: SG_SERVER secret is not set"
            exit 1
          fi
          echo "✓ SG_SERVER is set"
          
          # Write SSH key to file
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "✓ SSH key written to file"
          
          # Add server to known_hosts
          echo "Scanning SSH host keys for $SG_SERVER..."
          if output=$(ssh-keyscan -H "$SG_SERVER" 2>&1) && [ -n "$output" ]; then
            echo "$output" >> ~/.ssh/known_hosts
            echo "✓ SSH host keys added to known_hosts"
          else
            echo "⚠ ssh-keyscan failed or timed out"
            echo "This is OK - deployment will continue with StrictHostKeyChecking=no"
          fi
          
          # If passphrase is provided, try to remove it from the key
          if [ -n "$SSH_PASSPHRASE" ]; then
            echo "Attempting to remove passphrase from SSH key..."
            # Redirect all output including the informational messages
            if ssh-keygen -p -N "" -P "$SSH_PASSPHRASE" -f ~/.ssh/id_rsa >/dev/null 2>&1; then
              echo "✓ Passphrase removed successfully"
            else
              echo "Note: Could not remove passphrase (key might not be passphrase-protected or passphrase is incorrect)"
              echo "Continuing with original key..."
            fi
          fi
          
          echo "✓ SSH key setup completed"
      
      - name: Deploy via rsync
        env:
          SG_SERVER: ${{ secrets.SG_SERVER }}
          SG_PORT: ${{ secrets.SG_PORT }}
          SG_USER: ${{ secrets.SG_USER }}
          SG_PATH: ${{ secrets.SG_PATH }}
        run: |
          echo "Starting deployment to $SG_SERVER..."
          rsync -avz --checksum --delete \
            -e "ssh -p ${SG_PORT} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='*.log' \
            ./ ${SG_USER}@${SG_SERVER}:${SG_PATH}
          echo "✓ Files uploaded successfully"
      
      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/id_rsa
      
      - name: Deployment Complete
        run: |
          echo "✓ Deployment to SiteGround completed successfully!"
