name: Deploy to SiteGround

on:
  push:
    branches:
      # - main
      - copilot/add-ztest-page

jobs:
  deploy:
    name: Deploy to SiteGround Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SG_SSH_PRIVATE_KEY }}
          SSH_PASSPHRASE: ${{ secrets.SG_SSH_PASSPHRASE }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Validate SSH key is provided
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "Error: SG_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          # Write SSH key to file
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add server to known_hosts
          ssh-keyscan -H ${{ secrets.SG_SERVER }} >> ~/.ssh/known_hosts
          
          # If passphrase is provided, try to remove it from the key
          if [ -n "$SSH_PASSPHRASE" ]; then
            echo "Attempting to remove passphrase from SSH key..."
            if ssh-keygen -p -N "" -P "$SSH_PASSPHRASE" -f ~/.ssh/id_rsa 2>/dev/null; then
              echo "Passphrase removed successfully"
            else
              echo "Note: Could not remove passphrase (key might not be passphrase-protected or passphrase is incorrect)"
              echo "Continuing with original key..."
            fi
          fi
          
          echo "SSH key setup completed"
      
      - name: Deploy via rsync
        env:
          SG_SERVER: ${{ secrets.SG_SERVER }}
          SG_PORT: ${{ secrets.SG_PORT }}
          SG_USER: ${{ secrets.SG_USER }}
        run: |
          rsync -avz --delete \
            -e "ssh -p ${SG_PORT} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='*.log' \
            ./ ${SG_USER}@${SG_SERVER}:~/public_html/
      
      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/id_rsa
      
      - name: Deployment Complete
        run: |
          echo "Deployment to SiteGround completed successfully!"
          echo "Application URL: https://${SG_SERVER}"
